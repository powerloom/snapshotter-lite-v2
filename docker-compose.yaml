services:
  snapshotter-lite-local-collector:
    image: ghcr.io/powerloom/snapshotter-lite-local-collector:${LOCAL_COLLECTOR_IMAGE_TAG}
    container_name: snapshotter-lite-local-collector-${FULL_NAMESPACE}
    profiles: ["local-collector"]
    expose:
      - ${LOCAL_COLLECTOR_PORT}
    ports:
      - ${LOCAL_COLLECTOR_PORT}:${LOCAL_COLLECTOR_PORT}
      - ${LOCAL_COLLECTOR_P2P_PORT:-8001}:${LOCAL_COLLECTOR_P2P_PORT:-8001}
      - ${LOCAL_COLLECTOR_HEALTH_CHECK_PORT:-8080}:${LOCAL_COLLECTOR_HEALTH_CHECK_PORT:-8080}
    volumes:
      - ./logs-collector-${FULL_NAMESPACE_LOWER}:/app/logs
      - ./logs-collector-${FULL_NAMESPACE_LOWER}/archive:/app/logs/archive
    environment:
      - DATA_MARKET_CONTRACT=$DATA_MARKET_CONTRACT
      - LOCAL_COLLECTOR_PORT=$LOCAL_COLLECTOR_PORT
      - LOCAL_COLLECTOR_PRIVATE_KEY=$LOCAL_COLLECTOR_PRIVATE_KEY
      - PUBLIC_IP=${PUBLIC_IP}
      - BOOTSTRAP_NODE_ADDRS=${BOOTSTRAP_NODE_ADDRS}
      - LOCAL_COLLECTOR_P2P_PORT=${LOCAL_COLLECTOR_P2P_PORT:-8001}
      - RENDEZVOUS_POINT=${RENDEZVOUS_POINT:-powerloom-snapshot-sequencer-network}
      - GOSSIPSUB_SNAPSHOT_SUBMISSION_PREFIX=${GOSSIPSUB_SNAPSHOT_SUBMISSION_PREFIX:-/powerloom/snapshot-submissions}
      - HEALTH_CHECK_PORT=${LOCAL_COLLECTOR_HEALTH_CHECK_PORT:-8080}
      - SLACK_WEBHOOK_URL=${LOCAL_COLLECTOR_SLACK_WEBHOOK_URL}
      # Connection manager configuration (required for dsv-p2p branch)
      # CRITICAL: DSV nodes serve thousands of snapshotter peers (local collectors)
      # These limits must be high enough to prevent pruning publishers
      # For publisher role (lite nodes), lower values (100/400) are used as set by snapshotter CLI
      - CONN_MANAGER_LOW_WATER=${CONN_MANAGER_LOW_WATER:-100}
      - CONN_MANAGER_HIGH_WATER=${CONN_MANAGER_HIGH_WATER:-400}
      # Stream Pool Configuration (for centralized sequencer)
      - MAX_STREAM_POOL_SIZE=${MAX_STREAM_POOL_SIZE:-2}
      - MAX_STREAM_QUEUE_SIZE=${MAX_STREAM_QUEUE_SIZE:-1000}
      - STREAM_HEALTH_CHECK_TIMEOUT_MS=${STREAM_HEALTH_CHECK_TIMEOUT_MS:-5000}
      - STREAM_WRITE_TIMEOUT_MS=${STREAM_WRITE_TIMEOUT_MS:-5000}
      - MAX_WRITE_RETRIES=${MAX_WRITE_RETRIES:-3}
      - MAX_CONCURRENT_WRITES=${MAX_CONCURRENT_WRITES:-10}
      - STREAM_POOL_HEALTH_CHECK_INTERVAL=${STREAM_POOL_HEALTH_CHECK_INTERVAL:-60000}
      - CONNECTION_REFRESH_INTERVAL_SEC=${CONNECTION_REFRESH_INTERVAL_SEC:-300}
      - WRITE_SEMAPHORE_TIMEOUT_SEC=${WRITE_SEMAPHORE_TIMEOUT_SEC:-5}
      # Centralized Sequencer Control
      # Set to "false" to disable all submissions to centralized sequencer (mesh-only mode)
      # Set to "true" to enable dual submission (both centralized sequencer and mesh)
      - CENTRALIZED_SEQUENCER_ENABLED=${CENTRALIZED_SEQUENCER_ENABLED:-false}
      # Mesh Submission Concurrency Controls
      # Rate limiting for mesh submissions to prevent overwhelming the gossipsub network
      - MESH_SUBMISSION_RATE_LIMIT=${MESH_SUBMISSION_RATE_LIMIT:-100}
      - MESH_SUBMISSION_BURST_SIZE=${MESH_SUBMISSION_BURST_SIZE:-200}
      # Maximum concurrent mesh publish operations (goroutine limit)
      - MAX_MESH_PUBLISH_GOROUTINES=${MAX_MESH_PUBLISH_GOROUTINES:-500}
      # Maximum queued mesh submissions when rate limited
      - MESH_PUBLISH_QUEUE_SIZE=${MESH_PUBLISH_QUEUE_SIZE:-1000}
      # Other Configuration
      - DATA_MARKET_IN_REQUEST=${DATA_MARKET_IN_REQUEST:-true}
    networks:
      - custom_network
    deploy:
      resources:
        limits:
          memory: 150M
    restart: always
  snapshotter-lite-v2:
    image: ghcr.io/powerloom/snapshotter-lite-v2:${IMAGE_TAG}
    container_name: snapshotter-lite-v2-${SLOT_ID}-${FULL_NAMESPACE}
    volumes:
      - ./logs-${FULL_NAMESPACE_LOWER}:/app/logs
    environment:
      - SIGNER_ACCOUNT_ADDRESS=$SIGNER_ACCOUNT_ADDRESS
      - SIGNER_ACCOUNT_PRIVATE_KEY=$SIGNER_ACCOUNT_PRIVATE_KEY
      - FULL_NAMESPACE=$FULL_NAMESPACE
      - SLOT_ID=$SLOT_ID
      - SOURCE_RPC_URL=$SOURCE_RPC_URL
      - POWERLOOM_RPC_URL=$POWERLOOM_RPC_URL
      - IPFS_URL=$IPFS_URL
      - IPFS_API_KEY=$IPFS_API_KEY
      - IPFS_API_SECRET=$IPFS_API_SECRET
      - PROTOCOL_STATE_CONTRACT=$PROTOCOL_STATE_CONTRACT
      - DATA_MARKET_CONTRACT=$DATA_MARKET_CONTRACT
      - LOCAL_COLLECTOR_PORT=$LOCAL_COLLECTOR_PORT
      - NAMESPACE=$NAMESPACE
      - TELEGRAM_REPORTING_URL=$TELEGRAM_REPORTING_URL
      - TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID
      - TELEGRAM_MESSAGE_THREAD_ID=$TELEGRAM_MESSAGE_THREAD_ID
      - TELEGRAM_NOTIFICATION_COOLDOWN=$TELEGRAM_NOTIFICATION_COOLDOWN
      - SNAPSHOT_CONFIG_REPO=$SNAPSHOT_CONFIG_REPO
      - SNAPSHOT_CONFIG_REPO_BRANCH=$SNAPSHOT_CONFIG_REPO_BRANCH
      - SNAPSHOTTER_COMPUTE_REPO=$SNAPSHOTTER_COMPUTE_REPO
      - SNAPSHOTTER_COMPUTE_REPO_BRANCH=$SNAPSHOTTER_COMPUTE_REPO_BRANCH
    command: >
      bash -c "
        rm -f /app/last_successful_submission.txt;
        trap 'rm -f /app/last_successful_submission.txt' SIGTERM;
        bash init_docker.sh;
      "
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - custom_network
    restart: always
    deploy:
      resources:
        limits:
          memory: 200M
networks:
  custom_network:
    name: ${DOCKER_NETWORK_NAME}
    driver: bridge
    external: true
